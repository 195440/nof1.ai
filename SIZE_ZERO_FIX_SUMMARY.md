# Size=0 é—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æ ¹å› 

æ ¹æ®ç”¨æˆ·æä¾›çš„é”™è¯¯æ—¥å¿—ï¼š
```
"size":0
"Parameter sz error (sCode: 51000)"
```

OKX API æ‹’ç»äº†æ•°é‡ä¸º 0 çš„è®¢å•ã€‚ç»è¿‡ä»£ç åˆ†æï¼Œå‘ç°æœ‰**ä¸‰ä¸ªä¸»è¦é—®é¢˜**å¯¼è‡´ `size=0`ï¼š

## ğŸ› é—®é¢˜ 1ï¼šä½¿ç”¨ `Math.floor` å¯¼è‡´å‘ä¸‹å–æ•´ä¸º 0

### å¼€ä»“æ—¶ï¼ˆ`tradeExecution.ts:342`ï¼‰

**åŸä»£ç **ï¼š
```typescript
let quantity = (adjustedAmountUsdt * leverage) / (quantoMultiplier * currentPrice);
quantity = Math.floor(quantity); // âŒ å‘ä¸‹å–æ•´
```

**é—®é¢˜**ï¼š
- å¦‚æœè®¡ç®—å‡º `quantity = 0.9` å¼ 
- `Math.floor(0.9) = 0`
- å¯¼è‡´ä¸‹å•å¤±è´¥

**ä¿®å¤**ï¼š
```typescript
quantity = Math.ceil(quantity); // âœ… å‘ä¸Šå–æ•´ï¼Œè‡³å°‘å¼€ 1 å¼ 
```

### å¹³ä»“æ—¶ï¼ˆ`tradeExecution.ts:708`ï¼‰

**åŸä»£ç **ï¼š
```typescript
const closeSize = Math.floor((quantity * percentage) / 100); // âŒ å‘ä¸‹å–æ•´
```

**é—®é¢˜**ï¼š
- æŒä»“ 10 å¼ ï¼Œéƒ¨åˆ†å¹³ä»“ 5%
- `Math.floor(10 * 5 / 100) = Math.floor(0.5) = 0`
- å¯¼è‡´å¹³ä»“å¤±è´¥

**ä¿®å¤**ï¼š
```typescript
let closeSize = Math.ceil((quantity * percentage) / 100); // âœ… å‘ä¸Šå–æ•´
closeSize = Math.min(closeSize, quantity); // ç¡®ä¿ä¸è¶…è¿‡æŒä»“
```

## ğŸ› é—®é¢˜ 2ï¼šä½¿ç”¨ `parseInt` è€Œé `parseFloat`

### æ¸…ä»“æ—¶ï¼ˆ`tradingLoop.ts:1063`ï¼‰

**åŸä»£ç **ï¼š
```typescript
const size = Number.parseInt(pos.size || "0"); // âŒ parseInt æˆªæ–­å°æ•°
```

**é—®é¢˜**ï¼š
- å¦‚æœ `pos.size = "0.5"`
- `parseInt("0.5") = 0`
- å¯¼è‡´ä¸‹å• size=0

**ä¿®å¤**ï¼š
```typescript
const size = Number.parseFloat(pos.size || "0"); // âœ… ä½¿ç”¨ parseFloat

// æ·»åŠ éªŒè¯
if (size === 0 || !Number.isFinite(size)) {
  logger.warn(`è·³è¿‡æ— æ•ˆæŒä»“: ${symbol}, size=${pos.size}`);
  continue;
}
```

## ğŸ› é—®é¢˜ 3ï¼šç¼ºå°‘ size éªŒè¯

å¤šä¸ªåœ°æ–¹è°ƒç”¨ `placeOrder` æ—¶æ²¡æœ‰éªŒè¯ size æ˜¯å¦ä¸º 0ã€‚

**ä¿®å¤**ï¼šåœ¨æ‰€æœ‰å®¢æˆ·ç«¯çš„ `placeOrder` æ–¹æ³•å¼€å§‹å¤„æ·»åŠ éªŒè¯ï¼š

### OKX å®¢æˆ·ç«¯ï¼ˆ`okxClient.ts`ï¼‰

```typescript
async placeOrder(params: {...}): Promise<any> {
  // éªŒè¯ size å‚æ•°
  if (params.size === 0 || !Number.isFinite(params.size)) {
    throw new Error(`Invalid order size: ${params.size}. Size must be a non-zero finite number.`);
  }
  // ... ä¸‹å•é€»è¾‘
}
```

### Gate å®¢æˆ·ç«¯ï¼ˆ`gateClient.ts`ï¼‰

```typescript
async placeOrder(params: {...}) {
  // éªŒè¯ size å‚æ•°
  if (params.size === 0 || !Number.isFinite(params.size)) {
    throw new Error(`Invalid order size: ${params.size}. Size must be a non-zero finite number.`);
  }
  // ... ä¸‹å•é€»è¾‘
}
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `src/tools/trading/tradeExecution.ts`
   - å¼€ä»“ï¼šä½¿ç”¨ `Math.ceil` å‘ä¸Šå–æ•´
   - å¹³ä»“ï¼šä½¿ç”¨ `Math.ceil` å‘ä¸Šå–æ•´å¹¶éªŒè¯

2. âœ… `src/scheduler/tradingLoop.ts`
   - æ¸…ä»“ï¼šä½¿ç”¨ `parseFloat` è€Œé `parseInt`
   - æ·»åŠ  size æœ‰æ•ˆæ€§éªŒè¯

3. âœ… `src/services/okxClient.ts`
   - åœ¨ `placeOrder` å¼€å§‹å¤„æ·»åŠ  size éªŒè¯

4. âœ… `src/services/gateClient.ts`
   - åœ¨ `placeOrder` å¼€å§‹å¤„æ·»åŠ  size éªŒè¯

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ï¼š

| åœºæ™¯ | è®¡ç®—ç»“æœ | å–æ•´å | ä¸‹å•ç»“æœ |
|------|---------|--------|---------|
| å¼€ä»“ 0.9 å¼  | 0.9 | `Math.floor(0.9)` = **0** | âŒ å¤±è´¥ |
| å¹³ä»“ 5% (10å¼ ) | 0.5 | `Math.floor(0.5)` = **0** | âŒ å¤±è´¥ |
| æ¸…ä»“ "0.5" å¼  | "0.5" | `parseInt("0.5")` = **0** | âŒ å¤±è´¥ |

### ä¿®å¤åï¼š

| åœºæ™¯ | è®¡ç®—ç»“æœ | å–æ•´å | ä¸‹å•ç»“æœ |
|------|---------|--------|---------|
| å¼€ä»“ 0.9 å¼  | 0.9 | `Math.ceil(0.9)` = **1** | âœ… æˆåŠŸ |
| å¹³ä»“ 5% (10å¼ ) | 0.5 | `Math.ceil(0.5)` = **1** | âœ… æˆåŠŸ |
| æ¸…ä»“ "0.5" å¼  | "0.5" | `parseFloat("0.5")` = **0.5** | âœ… æˆåŠŸ |

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘ä¸Šå–æ•´çš„å½±å“

**å¼€ä»“æ—¶**ï¼š
- ä½¿ç”¨ `Math.ceil` å¯èƒ½ä¼šå¯¼è‡´å®é™…ä½¿ç”¨çš„ä¿è¯é‡‘**ç•¥é«˜äº**é¢„æœŸ
- ä¾‹å¦‚ï¼šè®¡ç®—éœ€è¦ 0.9 å¼ ï¼Œå‘ä¸Šå–æ•´ä¸º 1 å¼ 
- å½±å“è¾ƒå°ï¼Œå› ä¸ºä»£ç ä¸­å·²æœ‰éªŒè¯ç¡®ä¿è´¦æˆ·ä½™é¢è¶³å¤Ÿ

**å¹³ä»“æ—¶**ï¼š
- ä½¿ç”¨ `Math.ceil` å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†å¹³ä»“çš„æ•°é‡**ç•¥é«˜äº**é¢„æœŸç™¾åˆ†æ¯”
- ä¾‹å¦‚ï¼š10 å¼ æŒä»“ï¼Œå¹³ä»“ 5%ï¼Œå®é™…å¹³ 1 å¼ ï¼ˆ10%ï¼‰
- å·²æ·»åŠ  `Math.min(closeSize, quantity)` ç¡®ä¿ä¸è¶…è¿‡æŒä»“

### 2. æœ€å°è®¢å•æ•°é‡

ä¸åŒåˆçº¦çš„æœ€å°è®¢å•æ•°é‡ä¸åŒï¼š
- BTC_USDT: é€šå¸¸æœ€å° 1 å¼ 
- ETH_USDT: é€šå¸¸æœ€å° 1 å¼ 
- å°å¸‚å€¼å¸ç§ï¼šå¯èƒ½æœ€å° 10 å¼ æˆ–æ›´å¤š

ä»£ç ä¸­å·²é€šè¿‡ `contractInfo.orderSizeMin` è·å–å¹¶éªŒè¯æœ€å°æ•°é‡ã€‚

### 3. å°é¢äº¤æ˜“

å¯¹äºå°é¢äº¤æ˜“ï¼ˆå¦‚åªæœ‰å‡  USDT çš„ä¿è¯é‡‘ï¼‰ï¼Œå‘ä¸Šå–æ•´å¯èƒ½å¯¼è‡´ï¼š
- è®¡ç®—éœ€è¦ 0.1 å¼ ï¼Œå‘ä¸Šå–æ•´ä¸º 1 å¼ 
- å®é™…éœ€è¦çš„ä¿è¯é‡‘æ¯”é¢„æœŸé«˜ 10 å€

å»ºè®®ï¼š
- è®¾ç½®æœ€ä½å¼€ä»“ä¿è¯é‡‘é˜ˆå€¼ï¼ˆå¦‚ 10 USDTï¼‰
- åœ¨å¼€ä»“å‰æ£€æŸ¥å‘ä¸Šå–æ•´åçš„å®é™…ä¿è¯é‡‘éœ€æ±‚

## ğŸ” éªŒè¯æ–¹æ³•

### 1. å•å…ƒæµ‹è¯•åœºæ™¯

```typescript
// åœºæ™¯ 1ï¼šå°é¢å¼€ä»“
const quantity1 = (5 * 10) / (0.0001 * 60000); // 0.833 å¼ 
console.log(Math.ceil(quantity1)); // åº”è¯¥è¾“å‡º 1

// åœºæ™¯ 2ï¼šéƒ¨åˆ†å¹³ä»“
const closeSize2 = (10 * 3) / 100; // 0.3 å¼ 
console.log(Math.ceil(closeSize2)); // åº”è¯¥è¾“å‡º 1

// åœºæ™¯ 3ï¼šparseFloat vs parseInt
console.log(parseInt("0.5")); // 0 (é”™è¯¯)
console.log(parseFloat("0.5")); // 0.5 (æ­£ç¡®)
```

### 2. é›†æˆæµ‹è¯•

å»ºè®®æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼š
- [ ] å°é¢å¼€ä»“ï¼ˆå¦‚ 5 USDTï¼Œé«˜æ æ†ï¼‰
- [ ] éƒ¨åˆ†å¹³ä»“ï¼ˆå¦‚ 3%ã€5% ç­‰å°æ¯”ä¾‹ï¼‰
- [ ] æŒä»“æ•°é‡ä¸ºå°æ•°çš„æ¸…ä»“æ“ä½œ

## ğŸ“Š ä¸ä¹‹å‰ä¿®å¤çš„å…³è”

æœ¬æ¬¡ä¿®å¤ä¸ä¹‹å‰çš„ `quantoMultiplier` ä¿®å¤ç›¸å…³ï¼š

1. **ä¹‹å‰ä¿®å¤**ï¼šç¡®ä¿ `quantoMultiplier` å­—æ®µæ­£ç¡®è¯»å–ï¼ˆä¸ä¸º 0ï¼‰
2. **æœ¬æ¬¡ä¿®å¤**ï¼šç¡®ä¿è®¡ç®—å‡ºçš„ `size` ä¸ä¸º 0ï¼ˆæ­£ç¡®å–æ•´ï¼‰

ä¸¤ä¸ªé—®é¢˜éƒ½ä¼šå¯¼è‡´ç›¸ä¼¼çš„é”™è¯¯ï¼Œä½†æ ¹å› ä¸åŒï¼š
- `quantoMultiplier = 0` â†’ è®¡ç®—å…¬å¼åˆ†æ¯ä¸º 0 â†’ `quantity = Infinity` æˆ– `NaN`
- ä½¿ç”¨ `Math.floor` â†’ `quantity < 1` æ—¶ â†’ `size = 0`

## âœ… æ€»ç»“

é€šè¿‡ä»¥ä¸‹ä¸‰é¡¹ä¿®å¤ï¼Œå½»åº•è§£å†³äº† `size=0` å¯¼è‡´çš„ä¸‹å•å¤±è´¥é—®é¢˜ï¼š

1. **å‘ä¸Šå–æ•´**ï¼šä½¿ç”¨ `Math.ceil` ä»£æ›¿ `Math.floor`ï¼Œç¡®ä¿è‡³å°‘ä¸º 1
2. **ä½¿ç”¨ parseFloat**ï¼šæ­£ç¡®è§£æå°æ•°æŒä»“æ•°é‡
3. **ä¸¥æ ¼éªŒè¯**ï¼šåœ¨æ‰€æœ‰ä¸‹å•å…¥å£å¤„éªŒè¯ size æœ‰æ•ˆæ€§

è¿™äº›ä¿®å¤ç¡®ä¿äº†å³ä½¿åœ¨å°é¢äº¤æ˜“ã€éƒ¨åˆ†å¹³ä»“ç­‰è¾¹ç¼˜æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸å·¥ä½œã€‚

